upstream static_server {
        server static.gitbook.com:443;
}
upstream gstatic_server {
        server gstatic.gitbook.com:443;
}
upstream blobscdn_server {
        server blobscdn.gitbook.com:443;
}
upstream githubavatars_server {
        server avatars1.githubusercontent.com:443;
        server avatars2.githubusercontent.com:443;
        server avatars3.githubusercontent.com:443;
}
server {
        proxy_ssl_session_reuse off;
        listen 80;
        listen 443 ssl;
        server_name docs.authing.co;

        ssl on;
        ssl_certificate /etc/nginx/cert/docs.authing.co/cert1.pem;
        ssl_certificate_key /etc/nginx/cert/docs.authing.co/privkey1.pem;
        ssl_session_timeout 5m;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;
        location / {
                sub_filter_once off;
                sub_filter_types *;
                sub_filter_types *;
                sub_filter 'https://static.gitbook.com' 'https://docs.authing.co/static';       
                sub_filter 'blobs.gitbook.com' 'service-n14ldgzo-1255785256.hk.apigw.tencentcs.com/release/gitbookProxy';
                sub_filter 'gblobscdn.gitbook.com' 'service-2k76fzqg-1255785256.hk.apigw.tencentcs.com/release/gblobscdnProxy';
                sub_filter 'gstatic.gitbook.com' 'docs.authing.co/gstatic';
                sub_filter '<b>GitBook</b>' '<b id="powered-by-title">Authing</b>';
                sub_filter '%s - GitBook' '%s - Authing';
                sub_filter '"GitBook"' '"Authing"';
                sub_filter '</body>' '<script>setTimeout(function(){document.querySelector("#powered-by-title").innerText="Authing"},2000)</script></body>';
                proxy_set_header Host "learn.authing.cn";
                proxy_set_header User-Agent $http_user_agent;
                proxy_set_header Connection "";
                proxy_set_header Accept-Encoding "";
                proxy_pass https://learn.authing.cn/;
        }
        location /githubavatars/ {
                proxy_read_timeout 300s;
                proxy_connect_timeout 75s;
                proxy_set_header Connection "";
                proxy_set_header Accept-Encoding "";
                proxy_pass https://githubavatars_server/;
        }
        location /static/ {
                proxy_read_timeout 300s;
                proxy_connect_timeout 75s;
                proxy_set_header Host "static.gitbook.com";
                proxy_set_header User-Agent "";
                proxy_set_header reference "learn.authing.cn";
                proxy_set_header referrer "learn.authing.cn";
                proxy_set_header Connection "";
                proxy_set_header Accept-Encoding "";
                proxy_pass https://static_server/;
        }
        location /gstatic/ {
                proxy_read_timeout 300s;
                proxy_connect_timeout 75s;
                proxy_set_header Host "gstatic.gitbook.com";
                proxy_set_header User-Agent "";
                proxy_set_header reference "learn.authing.cn";
                proxy_set_header referrer "learn.authing.cn";
                proxy_set_header Connection "";
                proxy_set_header Accept-Encoding "";
                proxy_pass https://gstatic_server/;
        }
}
server {
        proxy_ssl_session_reuse off;
        listen 80;
        listen 443;
        server_name docs.authing.cn;

        ssl on;
        ssl_certificate /etc/nginx/cert/docs.authing.cn/1_docs.authing.cn_bundle.crt;
        ssl_certificate_key /etc/nginx/cert/docs.authing.cn/2_docs.authing.cn.key;
        ssl_session_timeout 5m;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;
        location / {
                sub_filter_once off;
                sub_filter_types *;
                sub_filter_types *;
                sub_filter 'https://static.gitbook.com' 'https://docs.authing.cn/static';       
                sub_filter 'blobs.gitbook.com' 'service-n14ldgzo-1255785256.hk.apigw.tencentcs.com/release/gitbookProxy';
                sub_filter 'gblobscdn.gitbook.com' 'service-2k76fzqg-1255785256.hk.apigw.tencentcs.com/release/gblobscdnProxy';
                sub_filter 'gstatic.gitbook.com' 'docs.authing.cn/gstatic';
                sub_filter '<b>GitBook</b>' '<b id="powered-by-title">Authing</b>';
                sub_filter '%s - GitBook' '%s - Authing';
                sub_filter '"GitBook"' '"Authing"';
                sub_filter '</body>' '<script>setTimeout(function(){document.querySelector("#powered-by-title").innerText="Authing"},2000)</script></body>';
                proxy_set_header Host "learn.authing.cn";
                proxy_set_header User-Agent $http_user_agent;
                proxy_set_header Connection "";
                proxy_set_header Accept-Encoding "";
                proxy_pass https://learn.authing.cn/;
        }
        location /githubavatars/ {
                proxy_read_timeout 300s;
                proxy_connect_timeout 75s;
                proxy_set_header Connection "";
                proxy_set_header Accept-Encoding "";
                proxy_pass https://githubavatars_server/;
        }
        location /static/ {
                proxy_read_timeout 300s;
                proxy_connect_timeout 75s;
                proxy_set_header Host "static.gitbook.com";
                proxy_set_header User-Agent "";
                proxy_set_header reference "learn.authing.cn";
                proxy_set_header referrer "learn.authing.cn";
                proxy_set_header Connection "";
                proxy_set_header Accept-Encoding "";
                proxy_pass https://static_server/;
        }
        location /gstatic/ {
                proxy_read_timeout 300s;
                proxy_connect_timeout 75s;
                proxy_set_header Host "gstatic.gitbook.com";
                proxy_set_header User-Agent "";
                proxy_set_header reference "learn.authing.cn";
                proxy_set_header referrer "learn.authing.cn";
                proxy_set_header Connection "";
                proxy_set_header Accept-Encoding "";
                proxy_pass https://gstatic_server/;
        }
}


